<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>终末地基质规划器 (Endfield Essence Planner)</title>
    <link rel="icon" href="./favicon.ico" sizes="any" />
    <link rel="icon" href="./favicon-002.ico" sizes="32x32" />
    <link rel="icon" href="./favicon-003.ico" sizes="48x48" />
    <link rel="icon" href="./favicon-003.ico" sizes="64x64" />
    <link rel="icon" type="image/png" href="./favicon.png" />
    <!-- 本地依赖（请将文件放到 ./vendor/） -->
    <link rel="stylesheet" href="./vendor/tailwind.min.css" />
    <script
      defer
      src="https://umami.canmoe.com/umcmx.js"
      data-website-id="98084554-f35b-4100-8bd4-262f490c9ae2"
    ></script>
        <link rel="stylesheet" href="./styles.css" />

  </head>
  <body>
    <div id="app" class="app-shell" v-cloak v-show="appReady">
      <header class="hero">
        <div>
          <h1>终末地基质规划器</h1>
          <p>
            根据 <span class="accent">附加/技能属性池</span> 与 <span class="accent">锁定规则</span> 自动判定共刷方案。
            基础属性仅可三选，系统会给出冲突提示与推荐三选。
          </p>
        </div>
        <div class="hero-actions">
          <button class="about-button notice-button" @click="openNotice">公告</button>
          <button class="about-button" @click="showAbout = true">关于</button>
        </div>
      </header>

      <main class="layout">
        <div class="mobile-tabs">
          <button
            class="mobile-tab"
            :class="{ active: mobilePanel === 'weapons' }"
            @click="mobilePanel = 'weapons'"
          >
            武器选择 <span class="count">{{ selectedNames.length }}</span>
          </button>
          <button
            class="mobile-tab"
            :class="{ active: mobilePanel === 'plans' }"
            @click="mobilePanel = 'plans'"
          >
            方案推荐 <span class="count">{{ recommendations.length }}</span>
          </button>
        </div>
        <div class="mobile-hint">手机端可通过上方标签切换“武器选择 / 方案推荐”。</div>
        <section class="panel" :class="{ 'panel-hidden': mobilePanel !== 'weapons' }">
          <div class="panel-title">
            <h2>武器选择器</h2>
            <button class="ghost-button" @click="clearSelection" :disabled="!selectedNames.length">
              清空
            </button>
          </div>

          <div class="search-box">
            <span>🔍</span>
            <input v-model="searchQuery" placeholder="搜索武器 / 属性..." />
          </div>

          <div class="filter-toolbar">
            <button
              class="ghost-button"
              :class="{ 'is-active': showWeaponAttrs }"
              @click="showWeaponAttrs = !showWeaponAttrs"
            >
              {{ showWeaponAttrs ? "隐藏属性" : "显示属性" }}
            </button>
            <button class="ghost-button" @click="showFilterPanel = !showFilterPanel">
              {{ showFilterPanel ? "折叠属性筛选" : "展开属性筛选" }}
            </button>
            <button
              class="ghost-button"
              :disabled="!hasAttributeFilters"
              @click="clearAttributeFilters"
            >
              清空属性筛选
            </button>
          </div>

          <div class="filter-panel" :class="{ 'is-collapsed': !showFilterPanel }">
            <div class="filter-group">
              <div class="filter-title">基础属性</div>
              <div class="filter-chips">
                <button
                  v-for="value in s1Options"
                  :key="value"
                  class="filter-chip"
                  :class="{ 'is-active': filterS1.includes(value) }"
                  @click="toggleFilterValue('s1', value)"
                >
                  {{ formatS1(value) }}
                </button>
              </div>
            </div>
            <div class="filter-group">
              <div class="filter-title">附加属性</div>
              <div class="filter-chips">
                <button
                  v-for="value in s2Options"
                  :key="value"
                  class="filter-chip"
                  :class="{ 'is-active': filterS2.includes(value) }"
                  @click="toggleFilterValue('s2', value)"
                >
                  {{ value }}
                </button>
              </div>
            </div>
            <div class="filter-group">
              <div class="filter-title">技能属性</div>
              <div class="filter-chips">
                <button
                  v-for="value in s3Options"
                  :key="value"
                  class="filter-chip"
                  :class="{ 'is-active': filterS3.includes(value) }"
                  @click="toggleFilterValue('s3', value)"
                >
                  {{ value }}
                </button>
              </div>
            </div>
          </div>

          <div class="tag-row">
            <span v-if="!selectedNames.length" class="tag">未选择任何武器</span>
            <span v-for="weapon in selectedWeapons" :key="weapon.name" class="tag">
              {{ weapon.name }}
              <button @click.stop="toggleWeapon(weapon)">✕</button>
            </span>
          </div>

          <div v-if="!showWeaponAttrs" class="weapon-list">
            <div
              v-for="weapon in filteredWeapons"
              :key="weapon.name"
              class="weapon-item"
              :class="{
                'is-selected': selectedNameSet.has(weapon.name),
                'rarity-6': weapon.rarity === 6,
                'rarity-5': weapon.rarity === 5,
              }"
              @click="toggleWeapon(weapon)"
            >
              <div class="weapon-art">
                <img
                  v-if="hasImage(weapon)"
                  class="weapon-figure"
                  :src="weaponImageSrc(weapon)"
                  :alt="weapon.name"
                />
                <span v-else class="weapon-fallback-large">{{ weapon.rarity }}★</span>
              </div>
              <div class="weapon-band"></div>
              <div class="weapon-name">{{ weapon.name }}</div>
            </div>
          </div>

          <div v-else class="weapon-attr-list">
            <div
              v-for="weapon in filteredWeapons"
              :key="weapon.name"
              class="scheme-weapon-item weapon-attr-item"
              :class="{ 'is-selected': selectedNameSet.has(weapon.name) }"
              @click="toggleWeapon(weapon)"
            >
              <div class="scheme-weapon-title">
                <div
                  class="weapon-mini"
                  :style="rarityBadgeStyle(weapon.rarity, hasImage(weapon))"
                >
                  <img v-if="hasImage(weapon)" :src="weaponImageSrc(weapon)" :alt="weapon.name" />
                  <span v-else class="weapon-fallback">{{ weapon.rarity }}★</span>
                </div>
                <span>{{ weapon.name }}</span>
                <span class="rarity" :style="rarityTextStyle(weapon.rarity)">
                  {{ weapon.rarity }}★
                </span>
                <span class="badge" v-if="selectedNameSet.has(weapon.name)">已选</span>
              </div>
              <div class="scheme-weapon-attrs">
                <span class="attr-value attr-type">{{ weapon.type }}</span>
                <span
                  class="attr-value"
                  :class="{ 'base-lock': filterS1.length && filterS1.includes(weapon.s1) }"
                >
                  {{ formatS1(weapon.s1) }}
                </span>
                <span
                  class="attr-value"
                  :class="{ locked: filterS2.length && filterS2.includes(weapon.s2) }"
                >
                  {{ weapon.s2 }}
                </span>
                <span
                  class="attr-value"
                  :class="{ locked: filterS3.length && filterS3.includes(weapon.s3) }"
                >
                  {{ weapon.s3 }}
                </span>
              </div>
            </div>
          </div>
        </section>

        <section class="panel" :class="{ 'panel-hidden': mobilePanel !== 'plans' }">
          <div class="panel-title">
            <h2>方案推荐列表</h2>
            <div class="panel-actions">
              <div class="pill">已选 {{ selectedWeapons.length }} 把</div>
              <button
                v-if="extraRecommendations.length"
                class="ghost-button"
                @click="showAllSchemes = !showAllSchemes"
              >
                {{ showAllSchemes ? "收起其他方案" : `展开其他方案（${extraRecommendations.length}）` }}
              </button>
            </div>
          </div>

          <div v-if="!selectedWeapons.length" class="empty">
            请选择至少一把武器，系统将自动推荐可共刷的副本方案。
          </div>

          <div v-else-if="!recommendations.length" class="recommendations">
            <div class="card">
              <div class="card-header">
                <div>
                  <div class="card-title">当前组合无可用方案</div>
                  <div class="hint">附加/技能属性无法统一锁定，或副本池不覆盖所需词条。</div>
                </div>
                <div class="strategy-row">
                  <span class="pill warn">请拆分批次刷取</span>
                </div>
              </div>

              <div class="lock-summary" v-if="fallbackPlan">
                <div class="lock-title">锁定方案（仅显示冲突提示）</div>
                <div class="lock-items">
                  <span class="lock-chip" :class="{ warn: fallbackPlan.baseOverflow }">
                    {{ fallbackPlan.baseOverflow ? "基础属性冲突" : "基础属性" }}：
                    {{
                      (fallbackPlan.baseOverflow ? fallbackPlan.baseAllLabels : fallbackPlan.basePickLabels).join(
                        " / "
                      )
                    }}
                  </span>
                  <span class="lock-chip warn" v-if="fallbackPlan.s2Conflict">
                    附加属性冲突（无法统一锁定）
                  </span>
                  <span class="lock-chip warn" v-if="fallbackPlan.s3Conflict">
                    技能属性冲突（无法统一锁定）
                  </span>
                </div>
              </div>

              <div class="hint">已选武器（冲突项标红）</div>
              <div class="scheme-weapon-list">
                <div
                  v-for="weapon in fallbackPlan.weaponRows"
                  :key="weapon.name"
                  class="scheme-weapon-item is-selected"
                >
                  <div class="scheme-weapon-title">
                    <span>{{ weapon.name }}</span>
                    <span class="rarity" :style="rarityTextStyle(weapon.rarity)">
                      {{ weapon.rarity }}★
                    </span>
                    <span class="badge">已选</span>
                  </div>
                  <div class="scheme-weapon-attrs">
                    <span class="attr-value attr-type">类型：{{ weapon.type }}</span>
                    <span
                      class="attr-value"
                      :class="{
                        'base-lock': weapon.baseLocked,
                        conflict: weapon.baseConflict,
                      }"
                    >
                      基础属性：{{ formatS1(weapon.s1) }}
                    </span>
                    <span class="attr-value" :class="{ conflict: fallbackPlan.s2Conflict }">
                      附加属性：{{ weapon.s2 }}
                    </span>
                    <span class="attr-value" :class="{ conflict: fallbackPlan.s3Conflict }">
                      技能属性：{{ weapon.s3 }}
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div v-else class="recommendations">
            <div v-if="coverageSummary && coverageSummary.hasGap" class="card">
              <div class="card-header">
                <div>
                  <div class="card-title">当前组合需要分批刷取</div>
                  <div class="hint">
                    该组合无法在同一批次完成，已生成 {{ recommendations.length }} 套方案覆盖全部已选武器，
                    并按效率优先排序，请在下方查看。如需查看更多方案请点击展开其他方案按钮。
                  </div>
                </div>
                <div class="strategy-row">
                  <span class="pill warn">需分批次刷取</span>
                </div>
              </div>
            </div>
            <div v-for="card in visibleRecommendations" :key="card.schemeKey" class="card">
              <div class="card-header">
                <div>
                  <div class="card-title">{{ card.dungeon.name }}</div>
                  <div class="hint" v-if="card.displaySelectedMatchCount === selectedWeapons.length">
                    附加属性池 / 技能属性池 均已满足所选武器需求
                  </div>
                  <div class="hint" v-else>
                    已覆盖 {{ card.displaySelectedMatchCount }} / {{ selectedWeapons.length }} 把已选武器，剩余需拆分刷取。
                  </div>
                  <details
                    v-if="card.displaySelectedMissingNames.length"
                    class="missing-details"
                    :open="selectedWeapons.length > 1"
                  >
                    <summary>未覆盖 {{ card.displaySelectedMissingNames.length }} 把</summary>
                    <div class="missing-tags">
                      <span
                        v-for="name in card.displaySelectedMissingNames"
                        :key="name"
                        class="missing-tag"
                      >
                        {{ name }}
                      </span>
                    </div>
                  </details>
                </div>
                <div class="strategy-row">
                  <span class="pill wide">
                    可同时刷武器：{{ card.displayWeaponCount }} 把（覆盖已选 {{ card.displaySelectedMatchCount }} 把）
                  </span>
                  <span class="pill" v-if="card.maxWeaponCount !== card.displayWeaponCount">
                    最多可刷：{{ card.maxWeaponCount }} 把
                  </span>
                  <span class="pill warn" v-if="card.displaySelectedMissingNames.length">
                    未覆盖 {{ card.displaySelectedMissingNames.length }}
                  </span>
                </div>
              </div>
              <div class="lock-summary">
                <div class="lock-title">锁定方案</div>
                <div class="lock-items">
                  <span
                    class="lock-chip"
                    :class="{ warn: card.manualPickNeeded || card.manualPickOverflow }"
                  >
                    基础属性：{{ card.basePickLabels.join(" / ") }}
                  </span>
                  <span class="lock-chip attr">锁定{{ card.lockLabel }}：{{ card.lockValue }}</span>
                </div>
                <div
                  class="hint"
                  v-if="card.baseOverflow"
                  :class="{ 'status-warn': card.manualPickOverflow }"
                >
                  <span v-if="card.manualPickOverflow">
                    已选择超过三种基础属性，请拆分并放弃一种属性。
                  </span>
                  <span v-else-if="card.manualPickNeeded">
                    基础属性超过三选，请在下方点击武器选择你想要刷取的基础属性（还需选择
                    {{ card.manualPickNeeded }} 个）
                  </span>
                  <span v-else>基础属性已锁定，可同时刷范围已更新。</span>
                </div>
              </div>

              <div class="scheme-weapon-list">
                <div
                  v-for="weapon in card.weaponRows"
                  :key="weapon.name"
                  class="scheme-weapon-item"
                  :class="{
                    'is-selected': weapon.isSelected,
                    'base-selectable': card.baseOverflow,
                    'is-dim': weapon.baseDim,
                  }"
                  :title="card.baseOverflow ? '点击选择基础属性' : ''"
                  @click="toggleSchemeBasePick(card, weapon)"
                >
                  <div class="scheme-weapon-title">
                    <div class="weapon-mini" :style="rarityBadgeStyle(weapon.rarity, hasImage(weapon))">
                      <img v-if="hasImage(weapon)" :src="weaponImageSrc(weapon)" :alt="weapon.name" />
                      <span v-else class="weapon-fallback">{{ weapon.rarity }}★</span>
                    </div>
                    <span>{{ weapon.name }}</span>
                    <span class="rarity" :style="rarityTextStyle(weapon.rarity)">
                      {{ weapon.rarity }}★
                    </span>
                    <span v-if="weapon.isSelected" class="badge">已选</span>
                  </div>
                  <div class="scheme-weapon-attrs">
                    <span class="attr-value attr-type">类型：{{ weapon.type }}</span>
                    <span
                      class="attr-value"
                      :class="{ 'base-lock': weapon.baseLocked, conflict: weapon.baseConflict }"
                    >
                      基础属性：{{ formatS1(weapon.s1) }}
                    </span>
                    <span class="attr-value" :class="{ locked: card.lockType === 's2' }">
                      附加属性：{{ weapon.s2 }}
                    </span>
                    <span class="attr-value" :class="{ locked: card.lockType === 's3' }">
                      技能属性：{{ weapon.s3 }}
                    </span>
                  </div>
                </div>
              </div>

            </div>
            <div class="expand-row" v-if="extraRecommendations.length">
              <button class="ghost-button" @click="showAllSchemes = !showAllSchemes">
                {{ showAllSchemes ? "收起其他方案" : `展开其他方案（${extraRecommendations.length}）` }}
              </button>
            </div>
          </div>
        </section>
      </main>

      <transition name="fade-scale">
        <div v-if="showNotice" class="about-overlay notice-overlay" @click.self="closeNotice">
          <div class="about-card notice-card">
            <h3>{{ announcement.title }}</h3>
            <p class="notice-meta">更新日期：{{ announcement.date }}</p>
            <ul class="notice-list">
              <li v-for="item in announcement.items" :key="item">{{ item }}</li>
            </ul>
            <div class="notice-qq" v-if="announcement.qqGroup">
              QQ 群：{{ announcement.qqGroup }}
              <span v-if="announcement.qqNote">（{{ announcement.qqNote }}）</span>
            </div>
            <label class="notice-skip">
              <input type="checkbox" v-model="skipNotice" />
              本次公告不再显示
            </label>
            <div class="about-actions">
              <button class="ghost-button" @click="closeNotice">关闭</button>
            </div>
          </div>
        </div>
      </transition>

      <transition name="fade-scale">
        <div v-if="showAbout" class="about-overlay" @click.self="showAbout = false">
          <div class="about-card">
            <h3>{{ aboutContent.title }}</h3>
            <p v-for="(line, index) in aboutContent.paragraphs" :key="`about-line-${index}`">
              {{ line }}
            </p>
            <p v-if="aboutContent.author">作者：{{ aboutContent.author }}</p>
            <div class="about-links" v-if="aboutContent.links && aboutContent.links.length">
              <a
                v-for="link in aboutContent.links"
                :key="link.href || link.text"
                class="repo-link"
                :href="link.href"
                target="_blank"
                rel="noreferrer"
              >
                <span class="repo-chip">{{ link.chip }}</span>
                <span>{{ link.text }}</span>
                <span class="repo-arrow">↗</span>
              </a>
            </div>
            <div class="about-actions">
              <button class="ghost-button" @click="showAbout = false">关闭</button>
            </div>
          </div>
        </div>
      </transition>

      <div v-if="showDomainWarning" class="domain-overlay">
        <div class="domain-card">
          <h3>非官方域名提示</h3>
          <p>
            当前访问域名并非
            <a class="domain-link" href="https://end.canmoe.com" target="_blank" rel="noreferrer">
              end.canmoe.com
            </a>
            ，请确认是否为可信来源，谨防恶意映射或页面被内嵌篡改。
          </p>
          <p class="domain-chip">当前页面域名：{{ currentHost }}</p>
          <p v-if="isEmbedded" class="domain-chip">上层页面域名：{{ embedHostLabel }}</p>
          <p v-if="isEmbedded && !isEmbedTrusted">该域名未在内嵌白名单内。</p>
          <p v-if="isEmbedded">检测到页面被内嵌（iframe）打开，此提示无法关闭。</p>
          <div class="about-actions domain-actions">
            <a
              class="repo-link domain-primary"
              href="https://end.canmoe.com"
              target="_blank"
              rel="noreferrer"
            >
              <span class="repo-chip">OFFICIAL</span>
              <span>访问官方域名</span>
              <span class="repo-arrow">↗</span>
            </a>
            <button
              v-if="!isEmbedded"
              class="ghost-button"
              :disabled="warningCountdown > 0"
              @click="dismissDomainWarning"
            >
              {{ warningCountdown > 0 ? `我已知晓（${warningCountdown}s）` : "我已知晓" }}
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="./vendor/vue.global.prod.js"></script>
    <script src="./data/dungeons.js"></script>
    <script src="./data/weapons.js"></script>
    <script src="./data/weapon-images.js"></script>
    <script src="./data/content.js"></script>
    <script src="./app.js"></script>
  </body>
</html>
